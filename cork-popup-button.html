<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../cork-icons/cork-icons.html">

<dom-module id="cork-popup-button">
  <template>
    <style>
      :host {
        display: inline-block;
      }

      button {
        cursor: pointer;
        font-size: var(--cork-font-size, 16px);
        width: 100%;
        text-align: left;
        border-radius: 0;
        background: var(--cork-background-color, var(--default-background-color, transparent));
        color: var(--cork-color, var(--default-text-color,  black));
        border: var(--cork-border, 1px solid #AFA6A1);
        display: flex;
        align-items: center;
        padding: 5px;
      }
      button[open] {
        background: var(--cork-background-color-open, #eee);
        color: var(--cork-color-open, #912046);
      }

      #anchor {
        position: relative;
      }

      #triangle {
        z-index: 1001;
        position: absolute;
        left: 5px;
        top: -21px;

        --iron-icon-height: 32px;
        --iron-icon-width: 32px;
      }

      #popup {
        z-index: 1000;
        background-color: var(--cork-popup-background-color, var(--primary-background-color, #fff));
        box-shadow: 0 0 8px #666;
        position: absolute;
        top: 10px;
        left: 0;
        width: var(--cork-popup-width);
        min-width: 290px;
      }

      #btnLabel {
        flex: 1;
        overflow: hidden;
        white-space: nowrap;
      }

      iron-icon[icon="arrow-drop-down"] {
        color: var(--cork-drop-down-arrow-color, #912046);
      }

      [hidden] {
        display: none;
      }
    </style>

    <button id="btn" on-click="_onClick" open$="[[open]]">
      <span id="btnLabel">[[label]]</span>
      <iron-icon icon="arrow-drop-down"></iron-icon>
    </button>

    <div id="anchor" hidden$="[[!open]]" on-click="_prevent">
      <iron-icon icon="cork:up-arrow" id="triangle"></iron-icon>
      <div id="popup">
        <slot></slot>
      </div>
    </div>

  </template>

  <script>
    /**
     * `cork-popup-button`
     * Select button with generic popup that can be a menu or something more complex
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CorkPopupButton extends Polymer.Element {
      static get is() { return 'cork-popup-button'; }
      static get properties() {
        return {
          label: {
            type: String,
            value: 'Select'
          },
          open: {
            type: Boolean,
            value: false
          }
        };
      }

      constructor() {
        super();
        this.hide = this.hide.bind(this);
        this._resetTriangle = this._resetTriangle.bind(this);
        
      }

      connectedCallback() {
        super.connectedCallback();
        window.addEventListener('click', this.hide);
        window.addEventListener('resize', this._resetTriangle);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        window.removeEventListener('click', this.hide);
        window.removeEventListener('resize', this._resetTriangle);
      }

      toggle() {
        this.open = !this.open;
        this._resetTriangle();
      }

      _onClick(e) {
        this._prevent(e);
        this.toggle();
      }

      _prevent(e) {
        e.preventDefault();
        e.stopPropagation();

        var payload = {
          detail: {
            src: this
          }
        }
        window.dispatchEvent(new CustomEvent('click', payload));
      }

      hide(e) {
        if( e && e.detail && e.detail.src === this ) {
          return;
        }

        this.open = false;
      }

      _resetTriangle() {
        if( !this.open ) return;

        var ww = window.innerWidth;
        var pw = this.$.popup.offsetWidth;

        var offset = this.$.btn.getBoundingClientRect();
        var bl = offset.left;
        var bw = offset.width;

        if( ww <= 768 ) {
          this.$.popup.style.left = (-1 * bl) + 'px';
          this.$.popup.style.right = (-1 * (ww - bl - bw)) + 'px';
        } else {
          this.$.popup.style.left = 0;
          this.$.popup.style.right = 'inherit';
        }

        setTimeout(() => {
          pw = this.$.popup.offsetWidth;
          var l = bw - 36;
          var max = pw - 50;
          if( l > max ) l = max;

          this.$.triangle.style.left = l+'px';
        }, 0);
      }
    }

    window.customElements.define(CorkPopupButton.is, CorkPopupButton);
  </script>
</dom-module>